---
title: 'Proyecto AED: Análisis de la Calidad de Vida en España'
author: "Daniela Meriño, Victor Mateu, Antonio Nova"
date: "2024-12-31"
output:
  pdf_document: default
  html_document: default
  
---

## Introducción

La calidad de vida es un concepto multidimensional que abarca aspectos económicos, sociales, ambientales y subjetivos, reflejando el bienestar general de las personas en una sociedad. En este trabajo, analizaremos la calidad de vida en España, desglosada en diversas dimensiones, a lo largo de varias comunidades autónomas y un periodo de años.

El análisis se centra en múltiples dimensiones de la calidad de vida, como las condiciones materiales, la salud, la educación, el trabajo, las relaciones sociales, la seguridad, el entorno ambiental y la gobernanza, entre otras. Además, el enfoque temporal nos permitirá evaluar tendencias, identificar patrones y observar disparidades entre las diferentes comunidades autónomas.

Los datos utilizados para este estudio provienen de un conjunto estructurado que organiza información clave de calidad de vida por año, comunidad autónoma y dimensión. Este formato permitirá realizar comparaciones entre las regiones y temporales, utilizando herramientas estadísticas y visualizaciones  para descubrir las relaciones y diferencias significativas entre las regiones de España.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
rm(list=ls())
#librerias utilizadas:
library(tidyverse)
library(factoextra)
library(dendextend)
library(dplyr)
library(tidyr)
library(tinytex)
library(readxl)
library(bookdown)
library(sf)
library(ggplot2)
library(reshape2)
library(gridExtra)
library(ggcorrplot)
```

## Importación y Ordenación de los datos 

En este apartado, se procede a la importación y preparación de los datos proporcionados por el Instituto Nacional de Estadística (INE) de España. Los datos corresponden al [**Indicador Multidimensional de Calidad de Vida (IMCV)**](https://ine.es/experimental/imcv/experimental_ind_multi_calidad_vida.htm). Este indicador tiene como objetivo ofrecer una visión integral del bienestar en las distintas comunidades autónomas mediante la evaluación de múltiples dimensiones, como salud, educación, trabajo, entre otras.

Nuestro conjunto de datos se organiza en nueve dimensiones. Estas abarcan aspectos clave como condiciones materiales de vida (renta, pobreza y seguridad económica), trabajo (empleo y calidad laboral), salud (esperanza de vida y determinantes como ejercicio y tabaquismo), educación (formación y abandono escolar), ocio y relaciones sociales (satisfacción y apoyo social), seguridad física (criminalidad y percepción de seguridad), gobernanza (confianza en instituciones y participación política), entorno (contaminación y acceso a zonas verdes) y experiencia de vida (satisfacción y propósito vital). Juntas, estas dimensiones ofrecen una visión del bienestar en las diferentes comunidades autónomas de España.

La naturaleza experimental de estos datos implica que están en proceso de consolidación metodológica y pueden incluir innovaciones en las fuentes de información. En este sentido, el primer paso es garantizar que los datos se encuentren correctamente estructurados y listos para su análisis.

En primer lugar, destacar que de este conjunto de datos utilizada tiene un número muy elevado de variables por lo que nosotros nos centraremos en los resultados globales de cada dimensión por comunidad autónoma por año.

Aunque, para enteder un poco mejor de cómo se han obtenido los datos del conjunto que vamos a analizar, destacar que el cálculo del **Indicador Multidimensional de Calidad de Vida (IMCV)** se basa en la selección de indicadores representativos de nueve dimensiones clave, como condiciones materiales de vida, salud, educación y trabajo, obtenidos de fuentes estadísticas como la Encuesta de Condiciones de Vida. Los valores de cada indicador se normalizan para permitir comparaciones homogéneas mediante el método Mazziotta-Pareto Ajustado (AMPI), que reescala los datos en un rango común y penaliza la variabilidad excesiva. Posteriormente, se agregan los valores normalizados de cada dimensión en un índice representativo, y finalmente, los índices de todas las dimensiones se combinan en un único valor global mediante una media ponderada. El resultado permite analizar la evolución temporal y las diferencias territoriales en la calidad de vida en España.

```{r, include=FALSE}

# Cargar los datos desde el archivo
file_path <- "data/datos_calidad_vida_multi.xlsx"
data <- read_excel(file_path, sheet = "AMPI Global", range = "A4:EO23")

# Limpiar los nombres de las columnas
colnames(data) <- gsub("\\.+", "", colnames(data))

# Sustituir comas por puntos en los valores numéricos y convertir a numeric
data[-1] <- lapply(data[-1], function(x) as.numeric(gsub(",", ".", as.character(x))))

# Corregir la asignación de nombres de columnas
# Número de dimensiones y años
num_dim <- 9  # Número de dimensiones por año
num_anios <- (ncol(data) - 1) / num_dim  # Calcular el número de años
anios <- seq(2008, 2008 + num_anios - 1)  # Generar la secuencia de años

# Crear nombres de columnas combinando años y dimensiones
colnames(data)[-1] <- paste0(rep(anios, each = num_dim), ".dim", rep(1:num_dim, times = length(anios)))

# Convertir a formato tidy
data_tidy <- data %>%
  pivot_longer(
    cols = -Total,
    names_to = c("Anio", "Dim"),
    names_sep = "\\.",
    values_to = "Valor"
  ) %>%
  rename(CCAA = Total) %>%  # Renombrar la columna 'Total' a 'CCAA'
  mutate(
    Anio = as.integer(Anio),  # Convertir años a entero
    Valor = as.numeric(Valor)  # Asegurar que los valores sean numéricos
  )

# Guardar el archivo tidy como CSV
write.csv(data_tidy, "Datos_Tidy.csv", row.names = FALSE)

```

Una vez tenemos una idea básica sobre el dataset que vamos a analizar, nos centraremos en la importación y ordenación de este. 

El fichero descargardo a través del INE se obtuvo en formato .xlsx, por lo que la importación se tuvo que realizar a través de la función _read_excel_ de la librería _readxl_. Se creo un código en R de manera que cumpla las conciones de un conjunto de datos considerado _tidy_. Esto requiere que cada variable está representada en una columna, cada observación de una variable está en una fila distinta, la primera fila incluye los nombres de las variables y los nombres deben ser representativos de las variables que almacenan. 

```{r, echo=FALSE}
data <- read.csv("Datos_Tidy.csv") #la importación funciona bien
head(data)
```

## Análisis de los datos

El análisis de datos es un proceso fundamental para extraer información relevante, identificar patrones y apoyar la toma de decisiones basada en evidencia. En este caso, los datos proporcionan información multidimensional que permite explorar la calidad de vida en diferentes comunidades autónomas a lo largo del tiempo. Este análisis combina técnicas descriptivas, como visualizaciones y resúmenes estadísticos, con enfoques más avanzados, como modelos estadísticos y exploraciones multivariantes. 

En primer lugar, notamos que no hay valores faltantes en el conjunto de datos, sin embargo sí se observó que ciertos valores para diferentes dimensiones se repetían durante varios años. Investigando esto se observó que no todos los indicadores están disponibles todos los años. Por ejemplo, el caso más extremo es el de la dimensión Gobernanza y Derechos Básicos para el que solo hay datos en el año 2013 y, parcialmente para 2022. Los valores para los otros años, que ya venían en el conjunto de datos descargados del INE, simplemente fueron repetidos el resto de años posteriores a la nueva adquisición de datos en 2023. También se puede observar la imputación de estos valores para las dimensiones Ocio y relaciones sociales y Experiencia general de la vida.

En primer lugar, vamos a analizar la relación de las diferentes dimensiones para cada comunidad autónoma. Esto se realiza calculando la matriz de correlación, a partir del método de Spearman, esta indicará una medida de cuán asociadas están las dimensiones.
En la siguiente gráfica vemos un ejemplo de matriz de correlación para la Comunidad Valenciana, pero esta se realizó para todas las comunidades, se pueden ver en el Anexo, al final del documento.


```{r, echo=FALSE,fig.width=5, fig.height=5}

# Obtener lista de CCAA únicas
ccaa <- "Comunitat Valenciana"

# Crear un bucle para calcular y guardar las matrices de correlación
  # Filtrar los datos para la CCAA actual
  ccaa_data <- data %>%
    filter(CCAA == ccaa)
  
  # Reorganizar los datos en formato ancho (dimensiones como columnas)
  ccaa_wide <- ccaa_data %>%
    select(Anio, Dim, Valor) %>%
    spread(key = Dim, value = Valor)
  
  # Calcular la matriz de correlación
  cor_matrix <- cor(ccaa_wide %>% select(-Anio), use = "complete.obs", method="spearman")
  
  # Crear el gráfico de la matriz de correlación
  plot <- ggcorrplot(cor_matrix, 
                     method = "circle", 
                     type = "lower",
                     lab = TRUE, 
                     lab_size = 3, 
                     colors = c("red", "white", "blue"),
                     title = paste("Matriz de Correlación -", ccaa),
                     tl.cex = 10, 
                     tl.srt = 45)

  
  # Mostrar un mensaje de progreso
  print(plot)

```

El análisis de las correlaciones entre dimensiones en todas las comunidades autónomas revela que las Condiciones Materiales de Vida, el Trabajo y la Educación son las dimensiones más interrelacionadas, formando el núcleo del bienestar socioeconómico. Estas tres dimensiones están particularmente conectadas en regiones como Navarra, País Vasco y Madrid, que presentan sistemas más integrados. Por otro lado, dimensiones como el Entorno y Medioambiente y el Ocio y Relaciones Sociales tienden a ser más independientes, con menor conexión con factores económicos, aunque en algunas comunidades, como la Comunitat Valenciana y Melilla, muestran una relación moderada con la seguridad. La Experiencia General de la Vida está influenciada principalmente por las condiciones materiales y el empleo, aunque su alcance es más amplio en regiones con mayor desarrollo social. Finalmente, en comunidades como Melilla, Ceuta y Extremadura, las dimensiones muestran una mayor independencia, reflejando realidades locales más desconectadas entre sí. Este panorama resalta cómo el bienestar general varía significativamente según el contexto regional.

Dado el volumen de datos disponibles, procedemos a simplificar el análisis calculando un promedio de todas las dimensiones para obtener un valor global de calidad de vida por comunidad autónoma y por año. Este enfoque nos permite mantener la representatividad de todas las dimensiones sin perder información relevante.

```{r, include = FALSE}
dimensiones <- unique(data$Dim)

for (dim in dimensiones) {
  # Filtrar los datos para la dimensión actual
  dim_all <- data %>%
    filter(Dim == dim)
  
  # Crear el gráfico
  plot <- ggplot(dim_all, aes(x = Anio, y = Valor, color = CCAA, group = CCAA)) +
    geom_line(size = 1) +
    geom_point(size = 2) +
    labs(
      x = "Año",
      y = "Valor",
      color = "CCAA",
      caption = "Fuente: Datos de Calidad de Vida"
    ) +
    theme_minimal()
  
  # Mostrar el gráfico
  print(plot) 
}
```


```{r, include=FALSE}
sum(!(is.finite(data$Anio)))
sum(!(is.finite(data$Valor)))
```

```{r, include=FALSE}

dimensiones <- unique(data$Dim)

nombre <- c(
  "Condiciones Materiales de Vida",
  "Trabajo",
  "Salud",
  "Educación",
  "Ocio y Relaciones Sociales",
  "Seguridad Física y Personal",
  "Gobernanza y Derechos Básicos",
  "Entorno y Medioambiente",
  "Experiencia General de la Vida"
)

# Lista para almacenar gráficos temporalmente
plots <- list()
i<-1
# Crear gráficos y almacenarlos en la lista
for (dim in dimensiones) {
  # Filtrar los datos para la dimensión actual
  dim_all <- data %>%
    filter(Dim == dim)
  
  # Crear el gráfico
  plot <- ggplot(dim_all, aes(x = Anio, y = Valor, color = CCAA, group = CCAA)) +
    geom_line(size = 1) +
    geom_point(size = 2) +
    labs(
      title = nombre[i],
      x = "Año",
      y = "Valor",
      color = "CCAA",
      caption = "Fuente: Datos de Calidad de Vida"
    ) +
    theme_minimal()
    #theme(legend.position = "none")  # Quitar la leyenda
  
  # Agregar el gráfico a la lista
  plots[[dim]] <- plot
  i<-i+1
  print(plot)
}

```


```{r, include=FALSE}
library(ggplot2)
#Importación del csv ordenado
data <- read.csv("Datos_Tidy.csv") #la importación funciona bien
```

```{r, include=FALSE}
#Valor global por CCAA
data_reducido <- data %>%
  group_by(CCAA, Anio) %>%
  summarise(Valor_Global = mean(Valor))

```

```{r, echo=FALSE}

plot <- ggplot(data_reducido, aes(x = Anio, y = Valor_Global, color = CCAA, group = CCAA)) +
    geom_line(size = 1) +
    geom_point(size = 2) +
    labs(
      title = "Valor Global de Calidad de Vida",
      x = "Año",
      y = "Valor",
      color = "CCAA",
      caption = "Fuente: Datos de Calidad de Vida"
    ) +
    theme_minimal()
print(plot)
```

En la gráfica anterior se puede observar el Valor Global de Calidad de Vida en las diferenetes comunidades de España a lo largo del tiempo. Comunidades como el País Vasco y Navarra destacan con valores considerablemente más altos, mientras que Ceuta presenta valores más bajos, reflejando disparidades en la calidad de vida. Aunque la mayoría de las regiones muestran una tendencia al alza, especialmente después de 2015, algunas experimentan fluctuaciones o estancamientos recientes. 

Una vez calculados los valores globales, clasificaremos las comunidades autónomas en clústeres que representen tres niveles: clase baja, media y alta, según su calidad de vida. Esto nos permitirá trabajar con menos datos de forma más manejable, conservando la gran parte de la información.


```{r, echo=FALSE}
library(factoextra)

# Filtrar el dataset para la dimensión deseada (por ejemplo, dim1)
dim_all <- data_reducido

# Crear una matriz con CCAA como filas y años como columnas
mat_dim <- dim_all %>%
  select(CCAA, Anio, Valor_Global) %>%
  pivot_wider(names_from = Anio, values_from = Valor_Global) %>%
  column_to_rownames("CCAA")

# Calcular la distancia euclidiana entre las CCAA
distancia <- dist(mat_dim, method = "euclidean")

# Realizar clustering jerárquico con el método Ward.D2
cluster_jerarquico <- hclust(distancia, method = "ward.D2")

# Graficar el dendrograma del clustering jerárquico
plot(cluster_jerarquico, main = "Clustering Jerárquico de las CCAA", xlab = "", ylab = "Altura")

# Determinar el número óptimo de clústeres usando métodos WSS y silhouette
fviz_nbclust(mat_dim, hcut, method = "wss")
fviz_nbclust(mat_dim, hcut, method = "silhouette")

# Cortar el dendrograma en 3 clústeres
grupos <- cutree(cluster_jerarquico, k = 3)

# Agregar la asignación de clústeres al dataset original
dim_all <- dim_all %>%
  left_join(data.frame(CCAA = rownames(mat_dim), Cluster = grupos), by = "CCAA")

# Ordenar el dataset por clúster y CCAA
dim_all <- dim_all %>%
  arrange(Cluster, CCAA)

dim_all <- dim_all %>%
  mutate(Cluster = case_when(
    Cluster == 1 ~ "Clase baja",
    Cluster == 2 ~ "Clase alta",
    Cluster == 3 ~ "Clase media",
    TRUE ~ as.character(Cluster)  # Mantener los valores originales
  ))

# Graficar los resultados del clustering
plot_cluster <- ggplot(dim_all, aes(x = Anio, y = Valor_Global, color = factor(Cluster), group = CCAA)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Clustering de Calidad de Vida Global",
    x = "Año",
    y = "Valor",
    color = "Cluster",
    caption = "Fuente: Datos de Calidad de Vida"
  ) +
  theme_minimal()

# Mostrar el gráfico
print(plot_cluster)


```

Ahora, para poder analizar también las dimensiones, se pensó en crear las 3 macrocomunidades autónomas (clase alta, media y baja) y realizar el promedio de las diferentes dimensiones dentro de cada macrocomunidad. Sin embargo, como pueden ser independientes de cada comunidad, primero hay que hacer un análisis de cada dimensión para saber si estas comunidades son factibles.

```{r, include =FALSE}
#este chunk no sirve era para ver si en las diferentes dimensiones tambien se cumplen los clusteres que se cumplian para el valor global

clases <- dim_all %>%
  select(CCAA, Cluster) %>%
  distinct()  # Evitar duplicados si hay múltiples años

# Unir las clases al dataset `data`
data <- data %>%
  left_join(clases, by = "CCAA")


prueba <- data %>%
  filter(Dim == "dim1")

# Graficar los resultados del clustering
plot <- ggplot(prueba, aes(x = Anio, y = Valor, color = factor(Cluster), group = CCAA)) +
    geom_line(size = 1) +
    geom_point(size = 2) +
    labs(
      title = "Dimensión 1",
      x = "Año",
      y = "Valor",
      color = "CCAA",
      caption = "Fuente: Datos de Calidad de Vida"
    ) +
    theme_minimal()
print(plot)

```

## Anexo {#sec-anexo}

### Matriz de correlación de Spearman entre dimensiones por CCAA

```{r, include=FALSE}

# Obtener lista de CCAA únicas
ccaa_list <- unique(data$CCAA)

# Crear un bucle para calcular y guardar las matrices de correlación
  # Filtrar los datos para la CCAA actual
for (ccaa in ccaa_list){
  ccaa_data <- data %>%
    filter(CCAA == ccaa)
  
  # Reorganizar los datos en formato ancho (dimensiones como columnas)
  ccaa_wide <- ccaa_data %>%
    select(Anio, Dim, Valor) %>%
    spread(key = Dim, value = Valor)
  
  # Calcular la matriz de correlación
  cor_matrix <- cor(ccaa_wide %>% select(-Anio), use = "complete.obs", method="spearman")
  
  # Crear el gráfico de la matriz de correlación
  plot <- ggcorrplot(cor_matrix, 
                     method = "circle", 
                     type = "lower",
                     lab = TRUE, 
                     lab_size = 3, 
                     colors = c("red", "white", "blue"),
                     title = paste("Matriz de Correlación -", ccaa),
                     tl.cex = 10, 
                     tl.srt = 45)

  
  # Mostrar un mensaje de progreso
  print(plot)
}
```

